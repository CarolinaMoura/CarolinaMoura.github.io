<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Designftw Chatroom</title>
    <script type="importmap">
            {
                "imports": {
                    "vue": "https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.esm-browser.js",
                    "vue-router": "https://cdn.jsdelivr.net/npm/vue-router@4.5.0/dist/vue-router.esm-browser.prod.js",
                    "@graffiti-garden/implementation-local": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-local@0.6.4/dist/browser/index.js",
                    "@graffiti-garden/implementation-remote": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-remote@0.6.2/dist/browser/index.js",
                    "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue@0.7.2/dist/browser/plugin.mjs"
                }
            }
        </script>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="profile.css" />
</head>

<body>
    <div id="app">
        <div v-if=" isLoading" class="black_background">
            <div id="loader_inner">
                <h2>Loading...</h2>
                <img src="svg/loader.svg">
            </div>
        </div>

        <div v-if="newChat" class="black_background" @click="newChat=false">
            <div id="new_chat_inner" @click.stop>
                <div class="top">
                    <h2>New Chat</h2>
                    <button @click="newChat=false">
                        X</button>
                </div>
                <ul>
                    <button v-for="user in allUsersWithoutMe()" @click="newConversation(user)">{{user.name}}</button>
                </ul>
            </div>
        </div>
        <div v-if="!$graffitiSession.value">
            <h1>DesignFTW Chatroom</h1>
            <button @click="$graffiti.login()">
                Log In
            </button>
        </div>
        <template v-if="$graffitiSession.value">

            <Profile v-if="profiling" @toggle="updateProfile"></Profile>
            <div id="nonloader">
                <div v-if="$graffitiSession.value" id="inbox">
                    <div id="navbar">
                        <Name :name="user.name" :content="" :picture="user.picture" @click="() => {profiling = true}">
                        </Name>
                        <div id="navbar_buttons">
                            <button id="new_chat" @click="() => {newChat=true}">
                                <img src="svg/new_chat.svg" />
                            </button>
                            <button id="logout" @click="logout()">
                                <img src="svg/logout.svg" />
                            </button>
                        </div>
                    </div>
                    <transition-group name="chat" tag="ul" id="chats" class="chat-list">
                        <li v-for="friend in friends" :key="friend.id" class="chat-item">
                            <button @click="changeConversation(friend)"
                                :class="{active_chat: currentConversation && currentConversation.id === friend.id}">
                                <Name :name="friend.name" :content="friend.lastMsg.content" :picture="friend.picture"
                                    @click="changeConversation(friend)"></Name>
                            </button>
                        </li>
                    </transition-group>
                </div>
                <div id="chat">
                    <div v-if="currentConversation" id="actual_chat">

                        <div id="chat_header">
                            <Name :name="currentConversation.name" :content="" :picture="currentConversation.picture">
                            </Name>
                        </div>

                        <graffiti-discover autopoll v-slot="{ objects: messageObjects, isInitialPolling }"
                            :channels="getChannel()" @updated="onMessagesUpdated" :schema="{
                            properties: {
                                value: {
                                    required: ['content', 'published'],
                                    properties: {
                                        content: { type: 'string' },
                                        published: { type: 'number' }
                                    }
                                }
                            }
                        }">
                            <ul id="messages" v-scroll-bottom>
                                <li v-for="object in messageObjects.sort((a,b)=>a.value.published-b.value.published)"
                                    :key="object.url" class="message-bubble"
                                    :class="{ my_message: object.actor === $graffitiSession.value.actor }"
                                    @mouseenter="hoveredMsg = object.url" @mouseleave="hoveredMsg = null">

                                    <div class="bubble-content">
                                        {{ object.value.content }}
                                        <span class="message_hour">{{getHour(object.value.published)}}</span>
                                    </div>

                                    <!-- <button v-if="hoveredMsg === object.url" class="options-btn"
                                        @click="toggleMenu(object.url)">â‹®</button>

                                    <ul v-if="openMenuMsg === object.url" class="options-menu"
                                        @mouseleave="openMenuMsg = null">
                                        <li @click="editMessage(object)">Edit</li>
                                        <li @click="deleteMessage(object)">Delete</li>
                                    </ul> -->
                                </li>
                            </ul>
                        </graffiti-discover>
                        <form @submit.prevent="sendMessage()">
                            <fieldset :disabled="sending">
                                <input type="text" id="message_input" v-model="myMessage" placeholder="Message"
                                    ref="messageInput" v-focus />
                                <input type="submit" :value="sending? 'Sending...' : 'Send'" />
                            </fieldset>
                        </form>

                    </div>
                    <div v-else id="no_conversation">
                        <h2>Click on a conversation to start chatting or on your profile to update it!</h2>
                    </div>

                </div>
            </div>

        </template>



    </div>
    </div>
    </div>

    <script src="index.js" type="module"></script>
</body>

</html>